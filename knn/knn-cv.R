library(FNN)
library(dplyr)

data(iris)

se <- iris %>%
  filter(Species == "setosa")

ve <- iris %>%
  filter(Species == "versicolor")

vi <- iris %>%
  filter(Species == "virginica")

train_X <- rbind(se[1:25,-5], ve[1:25,-5], vi[1:25,-5])
train_y <- c(se$Species[1:25], ve$Species[1:25], vi$Species[1:25])
test_X <- rbind(se[26:50,-5], ve[26:50,-5], vi[26:50,-5])
test_y <- c(se$Species[26:50], ve$Species[26:50], vi$Species[26:50])

# knn
res <- knn(train_X, test = test_X, cl = train_y, k = 3, prob = TRUE)
table(res)
# res
#  1  2  3
# 25 27 23

table(test_y)
# test_y
#  1  2  3
# 25 25 25

# accuracy
sum(res == test_y)/length(test_y)

# leave-one-out cross validation
res_cv <- knn.cv(train_X, cl = train_y, k = 3,
                 prob = TRUE, algorithm = "kd_tree")

#class probability
attr(res_cv, "prob")
# [1] 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000
# [8] 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000
# [15] 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000
# [22] 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000
# [29] 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000
# [36] 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000
# [43] 1.0000000 0.6666667 1.0000000 0.6666667 1.0000000 0.6666667 1.0000000
# [50] 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000
# [57] 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000
# [64] 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 0.6666667
# [71] 1.0000000 1.0000000 1.0000000 0.6666667 1.0000000

# Euclidean distance
attr(res_cv, "nn.dist") %>%
  head()
#   [,1]      [,2]      [,3]
# [1,] 0.1000000 0.1414214 0.1732051
# [2,] 0.1414214 0.1732051 0.3000000
# [3,] 0.2449490 0.2645751 0.2645751
# [4,] 0.2449490 0.2645751 0.3000000
# [5,] 0.1414214 0.1732051 0.2236068
# [6,] 0.3316625 0.3464102 0.3872983

# index of k nearest neighbors
attr(res_cv, "nn.index") %>%
  head()
# [,1] [,2] [,3]
# [1,]   18    5    8
# [2,]   13   10    3
# [3,]    4    7   13
# [4,]    3   13    9
# [5,]    1   18    8
# [6,]   19   11   20
